{% extends 'feed/base.html' %} {% load crispy_forms_tags %} {% load static %}
{% block content %}
{% include 'feed/navbar.html' %}
{% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible show fade" role="alert"> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
{% endif %}
<div class="container">
    <div class="row mt-3 mx-3">
        <div class="card shadow-sm col-md-4 col-sm-6 px-3 pt-3 pb-3" style="height: 195px">
        <!-- profile card for a user -->
            <div class="media">
                <div class="d-flex">
                    <img class="rounded-circle account-img" src="{{ u.profile.profile_pic.url }}" width="100" height="100"/>
                    <h3 class="mt-5 ms-3 text-break">{{ u.username }}</h3>
                    <p class="text-end" style="position:absolute;bottom:5px;right:5px;margin:0;padding:5px 3px;" >  {{ u.profile.friends.count }} Friends</p>
                </div>
            </div>
            {% if request.user == u %}
            <div class="edit_profile pb-2">
                <a class="fs-6 text-decoration-none mx-2" href="{% url 'edit_profile' %}">Edit Profile</a>
                <a class="p-2" href="{% url 'inbox' %}"><i class="fa-solid fa-message"></i></a>
            </div>
                {% endif %}
                {% if request.user == u %}
                                           <!-- Button trigger modal -->
                        <button type="button" class="btn btn-primary position-relative" data-bs-toggle="modal"
                                data-bs-target="#exampleModal"
                        style="max-width: fit-content">
                          Friend Requests
                            {% if rec_friend_requests %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    {{ rec_friend_requests.count }}
                                    <span class="visually-hidden">friend requests recieved</span>
                                </span>
                            {% endif %}
                        </button>
                        <!-- Modal for friend requests and sent -->
                        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                             aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Friend Requests</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                                <!-- friend requests recieved and sent display -->
                              <div class="modal-body">
                                    <label>Pending Sent Friend Requests ({{ sent_friend_requests.count }})</label>
                                    <hr class="my-2" />
                                    {% if not sent_friend_requests %}
                                    <p><i>No friend requests pending!</i></p>
                                    {% else %} {% for s_request in sent_friend_requests %}
                                    <a href="{{ s_request.to_user.profile.get_absolute_url }}"
                                      ><img
                                        src="{{ s_request.to_user.profile.profile_pic.url }}"
                                        class="rounded mr-2"
                                        width="40"
                                        height="40"
                                        alt=""
                                    /></a>
                                    <a class="text-dark fw-bold my-2" href="{{ s_request.to_user.profile.get_absolute_url }}"
                                       style="text-decoration: none"
                                      >{{ s_request.to_user.username }}</a
                                    >
                                    <small class="float-right">
                                      <a
                                        class="btn btn-warning mr-2"
                                        href="{% url 'cancel_friend_request' s_request.to_user.id %}"
                                        >Cancel</a
                                      >
                                    </small>
                                    <br /><br />
                                    {% endfor %}
                                    {% endif %}
                                <label>Friend Requests Recieved ({{ rec_friend_requests.count }})</label>
                                    <hr class="text-dark my-2" />
                                    {% if not rec_friend_requests %}
                                    <p><i>No friend requests recieved!</i></p>
                                    {% else %} {% for r_request in rec_friend_requests %}
                                    <a href="{{ r_request.from_user.profile.get_absolute_url }}"
                                      ><img
                                        src="{{ r_request.from_user.profile.profile_pic.url }}"
                                        class="rounded mr-2"
                                        width="40"
                                        height="40"
                                        alt=""
                                    /></a>
                                    <a class="mr-2 align-middle fw-bold"
                                      href="{{ r_request.from_user.profile.get_absolute_url }}" style="text-decoration: none">
                                        {{ r_request.from_user.username }}
                                    </a>
                                    <small class="float-right">
                                      <a class="btn btn-success mr-2" href="{% url 'accept_friend_request' r_request.from_user.id %}">
                                          Accept</a>
                                      <a class="btn btn-danger" href="/users/friend-request/delete/{{ r_request.from_user.id }}">
                                          Reject</a>
                                    </small>
                                    <br /><br />
                                    {% endfor %}
                                    {% endif %}
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        </div>
                {% endif %}

    <div class="col-md-4 col-sm-6 px-3 pt-3 pb-3">
    <!-- profile tabs for timeline, bio, friends, photos -->
    <ul class="nav justify-content-center nav-pills" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home"
                    type="button" role="tab" aria-controls="pills-home" aria-selected="true">Timeline</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile"
                type="button" role="tab" aria-controls="pills-profile" aria-selected="false">About</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact"
                type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Friends</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-photos-tab" data-bs-toggle="pill" data-bs-target="#pills-photos"
                type="button" role="tab" aria-controls="pills-photos" aria-selected="false">Photos</button>
      </li>
    </ul>
    <div class="tab-content mx-4 pt-2" id="pills-tabContent">
        <div class="tab-pane fade show active" style="outline: none" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab"
             tabindex="0">
            <button type="button" class="btn text-primary fw-bolder" data-bs-toggle="modal" data-bs-target="#post"
                        style="max-width: fit-content">Create a post
            </button>
            <!-- Modal for post creation form -->
            <div class="modal fade" id="post" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content" style="width: 800px">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Create Post</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                    <div class="modal-body">
                        <div class="row justify-content-center" style="width: 800px">
                              <div class="col-sm-9 col-md-7 col-lg-5 me-5">
                                    <form class="form-signin" method = "POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <fieldset class="form-group"><br>
                                        {{ post_form | crispy }}
                                    </fieldset>
                                    <div class="form-group text-center">
                                        <button class="btn btn-lg btn-primary btn-block text-uppercase"
                                                type="submit">Post</button><br>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    </div>
                  </div>
                </div>
              <div class="col-md-5 me-4">
              <!--post list display-->
                {% for post in posts%}
                    <div class="card card-signin my-3" style="width: 500px">
                      <div class="card-body">
                      {% if post.shared_username %}
                          <div class="position-relative border-bottom mb-3">
                              {% if not request.user == post.shared_username%}
                                <a href="{{ post.shared_username.profile.get_absolute_url }}">
                                    <img src="{{ post.shared_username.profile.profile_pic.url }}"
                                         class="rounded-circle"
                                         width="30"
                                         height="30" alt=""></a>
                                <a class="text-dark" href="{{ post.shared_username.profile.get_absolute_url }}"><b>
                                    {{ post.shared_username }}</b></a>
                              {% else %}
                                <a href="{% url 'home' %}"><img src="{{ post.shared_username.profile.profile_pic.url }}"
                                                                class="rounded-circle" width="30" height="30" alt=""></a>
                                <a class="text-dark" href="{% url 'home' %}"><b>{{ post.shared_username }}</b></a>
                              {% endif %}
                              <br><small class="text-muted">Shared on {{post.shared_date}}</small>
                              {% if post.shared_description != none %}
                              <br>
                              <a class="post-link text-dark text-break text-decoration-none" href="{% url 'post-detail' post.pk%}">
                                  {{ post.shared_description }}</a>
                              {% endif %}
                          </div>
                          <!--shared post display-->
                          <div class="shared-post mx-4">
                            {% if not request.user == post.username%}
                            <a href="{{ post.username.profile.get_absolute_url }}"><img src="{{ post.username.profile.profile_pic.url }}"
                                                                                        class="rounded-circle" width="30"
                                                                                        height="30" alt=""></a>
                            <a class="text-dark" href="{{ post.username.profile.get_absolute_url }}"><b>{{ post.username }}</b></a>
                            {% else %}
                            <a href="{% url 'home' %}"><img src="{{ post.username.profile.profile_pic.url }}"
                                                            class="rounded-circle" width="30" height="30" alt=""></a>
                            <a class="text-dark" href="{% url 'home' %}"><b>{{ post.username }}</b></a>
                            {% endif %}
                            <br><small class="text-muted">Posted on {{ post.date_posted }}</small>
                            <br>
                            <a class="post-link text-dark text-break text-decoration-none" href="{% url 'post-detail' post.pk %}">
                                {{ post.description }}</a>
                            {% if post.pic %}
                                <img class="mx-auto d-block" src="{{ post.pic.url }}" alt=" " style="max-block-size: 300px">
                            {% endif %}
                          </div>
                      {% else %}
                          <!-- delete post button -->
                          {% if request.user == post.username %}
                            <a type="button" class="float-end" data-bs-toggle="modal" data-bs-target="#deletepost"
                                                style="color: crimson"><i class="fa-solid fa-trash"></i>
                            </a>
                            {% endif %}
                            {% if request.user == post.shared_username %}
                            <a type="button" class="float-end" data-bs-toggle="modal" data-bs-target="#deletepost"
                                                style="color: crimson"><i class="fa-solid fa-trash"></i>
                            </a>
                            {% endif %}
                            <!-- Modal for deleting post confirmation -->
                            <div class="modal fade" id="deletepost" tabindex="-1" aria-labelledby="deletepostModalTitle"
                                 aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content" style="width: 500px">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="deletepostModalTitle">Delete Post</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                    <div class="modal-body">
                                        Are you sure you want to delete this post?
                                    </div>
                                     <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <a type="button" class="btn btn-danger" href="{% url 'post-delete' post.pk %}">Confirm Deletion</a>
                                     </div>
                                </div>
                              </div>
                            </div>
                            {% if not request.user == post.username%}
                            <a href="{{ post.username.profile.get_absolute_url }}"><img src="{{ post.username.profile.profile_pic.url }}"
                                                                                        class="rounded-circle" width="30"
                                                                                        height="30" alt=""></a>
                            <a class="text-dark" href="{{ post.username.profile.get_absolute_url }}"><b>{{ post.username }}</b></a>
                            {% else %}
                            <a href="{% url 'home' %}"><img src="{{ post.username.profile.profile_pic.url }}"
                                                            class="rounded-circle" width="30" height="30" alt=""></a>
                            <a class="text-dark" href="{% url 'home' %}"><b>{{ post.username }}</b></a>
                            {% endif %}
                        <br><small class="text-muted">Posted on {{ post.date_posted }}</small>
                        <br>
                          <a class="post-link text-dark text-break text-decoration-none" href="{% url 'post-detail' post.pk %}">
                              {{ post.description }}</a>
                        <br>
                          {% if post.pic %}
                              <img class="mx-auto d-block" src="{{ post.pic.url }}" alt=" " style="max-block-size: 300px">
                          {% endif %}
                      {% endif %}
                      <!-- sharing post form -->
                        <form class="d-share" method="POST" action="{% url 'share-post' post.pk%}" id="{{ post.pk }}">
                          {% csrf_token %}
                          <fieldset class=form-group">
                              {{ share_form | crispy }}
                          </fieldset>
                            <div class="form-group float-end">
                                        <button class="btn btn-sm btn-primary btn-block text-uppercase" type="submit">
                                            Share!</button><br>
                            </div>
                      </form>
                      </div>
                      <div class="card-footer">
                      {% if not request.user == post.username and not request.user == post.shared_username%}
                            <!-- button for liking a post -->
                         <button class="btn like float-sm-start" id="{{ post.id }}">
                             {% if post in is_liked %}
                                 <a type="icon" class="btn btn-danger btn-sm" href="{% url 'post-like' %}"
                                    id="likebtn{{ post.id }}"><i class="fa-solid fa-heart-crack"></i></a>
                             {% else %}
                                 <a type="icon" class="btn btn-primary btn-sm" href="{% url 'post-like' %}"
                                    id="likebtn{{ post.id }}"><i class="fa-solid fa-heart"></i></a>
                             {% endif %}
                         </button>
                            <!-- button for sharing a post -->
                          <button class="btn btn-success btn-sm mt-2" onclick="ShareButton({{post.pk}})">Share Post</button>
                      {% endif %}
                        <!-- button for viewing comments/expanding specific post -->
                      <a class="btn btn-sm btn-primary mt-2 float-end" href="{% url 'post-detail' post.pk %}">View Comments</a>
                      </div>
                    </div>
                {% endfor %}
              </div>
                <div class="container" style="width: max-content">
               <!-- pagination of post list display -->
                {% if posts.paginator.num_pages > 1  %}
                    {% if posts.has_previous %}
                        <a class="btn btn-outline-primary mb-4" href="?page=1">First</a>
                        <a class="btn btn-outline-primary mb-4" href="?page={{ posts.previous_page_number }}">Previous</a>
                    {% endif %}
                    {% for num in posts.paginator.page_range %}
                        {% if posts.number == num %}
                          <a class="btn btn-primary mb-4" href="?page={{ num }}">{{ num }}</a>
                        {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                          <a class="btn btn-outline-primary mb-4" href="?page={{ num }}">{{ num }}</a>
                        {% endif %}
                    {% endfor %}

                    {% if posts.has_next %}
                        <a class="btn btn-outline-primary mb-4" href="?page={{ posts.next_page_number }}">Next</a>
                        <a class="btn btn-outline-primary mb-4" href="?page={{ posts.paginator.num_pages }}">Last</a>
                    {% endif %}
                {% endif %}
                </div>
        </div>
        <!-- user bio display -->
        <div class="tab-pane fade" id="pills-profile" style="outline: none" role="tabpanel" aria-labelledby="pills-profile-tab"
             tabindex="0">
              <div class="list-group mt-2" style="max-width: 400px">
                {% if u.profile.name %}
                    <p class="list-group-item"> Name: {{ u.profile.name }}</p>
                {% endif %}
                {% if u.profile.birthdate %}
                    <p class="list-group-item"> Birthday: {{ u.profile.birthdate }}</p>
                {% endif %}
                {% if u.profile.location %}
                    <p class="list-group-item"> Location: {{ u.profile.location }} </p>
                {% endif %}
                {% if u.profile.bio %}
                    <div class="card">
                        <label class="text fw-bold mx-3">Bio</label>
                        <p class="card-body">{{ u.profile.bio }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- friends list display -->
      <div class="tab-pane fade" id="pills-contact" style="outline: none" role="tabpanel" aria-labelledby="pills-contact-tab"
           tabindex="0">
      <div class="mt-2" style="max-inline-size: fit-content">
        <div class="shadow-sm" style="background-color: white">
        {% if friends_list %}
              {% for user_p in friends_list %}
              <div class="pt-2 px-2">
                  <a href="{{ user_p.get_absolute_url }}"
                    ><img
                      src="{{ user_p.profile_pic.url }}"
                      class="rounded mr-2"
                      width="40"
                      height="40"
                      alt=""
                  /></a>

                  <a class="text-dark fw-bold" href="{{ user_p.get_absolute_url }}" style="text-decoration: none"> {{ user_p }} </a>
                  <small>
                  {% if request.user == u %}
                      <a
                      class="btn btn-danger"
                      href="{% url 'delete_friend' user_p.id %}"
                      >Unfriend</a>
                  </small>
                  <br /><br />
              </div>
              {% endif %}
              {% endfor %}
        </div>
          {% elif request.user == u %}
              <h5>
                <i
                  >You have no friends now! Make some new
                  <a href="{% url 'users_list' %}">friends here!</a></i
                >
              </h5>
          {% endif %}
        </div>
    </div>
    <!-- display for photos -->
    <div class="tab-pane fade" id="pills-photos" style="outline: none" role="tabpanel" aria-labelledby="pills-photos-tab"
         tabindex="0"></div>
</div>
</div>
    </div>
</div>
{% endblock content %}

{% block jsfiles %}
    <!-- script for the like button -->
<script>
	$(".like").click(function (e) {
    var id = this.id;
    var counter = this.counter;
    var href = $('.like').find('a').attr('href');
    e.preventDefault();

    $.ajax({
        url: href,
        data: {
          'likeId': id
        },
        success: function(response){
          if(response.liked){
              $('#likebtn' + id).html('<i class="fa-solid fa-heart-crack"></i>');
              $('#likebtn' + id).css("background-color", "#dc3545")
              $('#likebtn' + id).css("border-color", "#dc3545")
          }
          else{
              $('#likebtn' + id).html('<i class="fa-solid fa-heart"></i>');
              $('#likebtn' + id).css("background-color", "#007bff")
              $('#likebtn' + id).css("border-color", "#007bff")

          }
        }
      })
});
</script>
    <!-- script for the share button -->
<script type="text/javascript" src={% static 'js/feed.js' %}></script>
{% endblock jsfiles %}